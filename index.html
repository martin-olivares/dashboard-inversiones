<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Inversiones » Neobrutalist</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --background: #f4f4f4;
            --surface: #ffffff;
            --primary: #fde047; /* Amarillo Vibrante */
            --primary-dark: #facc15;
            --text-primary: #1c1c1c;
            --border-color: #1c1c1c;
        }
        body { 
            font-family: 'Figtree', sans-serif; 
            background-color: var(--background); 
            color: var(--text-primary);
        }
        [v-cloak] { display: none; }
        .chart-container { position: relative; height: 100%; min-height: 400px; }
        .hard-shadow { box-shadow: 4px 4px 0px 0px var(--border-color); }
        .hard-shadow-sm { box-shadow: 2px 2px 0px 0px var(--border-color); }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="antialiased">
    <div id="app" v-cloak class="max-w-screen-2xl mx-auto p-4 md:p-6 lg:p-8">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <aside class="lg:col-span-3">
                <div class="p-6 bg-white border-2 border-black rounded-xl hard-shadow sticky top-8">
                    <div class="flex items-center space-x-3 mb-8">
                        <div class="bg-yellow-300 p-2 border-2 border-black rounded-md">
                            <svg class="h-6 w-6 text-black" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                            </svg>
                        </div>
                        <h1 class="text-2xl font-extrabold">StockDash</h1>
                    </div>
                    <div class="space-y-4">
                        <h2 class="font-bold text-lg">Añadir Activo</h2>
                        <input type="text" v-model="newStockTicker" @keyup.enter="addStock" placeholder="Ticker, ej: AAPL" class="w-full px-4 py-2 bg-white border-2 border-black rounded-md focus:ring-2 focus:ring-yellow-400 focus:border-black transition">
                        <button @click="addStock" :disabled="isLoading" class="w-full bg-yellow-300 text-black font-bold px-5 py-2 rounded-md border-2 border-black transition-all duration-200 hover:bg-yellow-400 active:translate-x-0.5 active:translate-y-0.5 active:shadow-none hard-shadow-sm disabled:bg-gray-300 disabled:cursor-not-allowed">
                            <span v-if="!isLoading">Agregar</span>
                            <span v-if="isLoading">Cargando...</span>
                        </button>
                         <p v-if="error" class="text-red-600 text-sm mt-2 animate-fade-in">{{ error }}</p>
                    </div>
                </div>
            </aside>

            <main class="lg:col-span-9">
                <div v-if="isLoadingInitial" class="flex justify-center items-center h-96">
                    <div class="w-12 h-12 border-4 border-black border-dashed rounded-full animate-spin"></div>
                </div>
                
                <div v-else class="space-y-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-5">
                        <kpi-card v-for="ticker in trackedStocks" :key="ticker" :stock="stockData[ticker]" :is-active="activeDetailStock === ticker" @select="setActiveDetail" @remove="removeStock"></kpi-card>
                    </div>
                    
                    <template v-if="trackedStocks.length > 0">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 p-6 bg-white border-2 border-black rounded-xl hard-shadow">
                                <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                                    <h3 class="font-bold text-lg">Histórico y Proyección</h3>
                                    <div class="flex flex-wrap justify-center gap-1.5">
                                        <button v-for="ticker in trackedStocks" @click="toggleStockInChart(ticker)" :class="[selectedStocksInChart.includes(ticker) ? 'bg-black text-white' : 'bg-gray-200 text-black hover:bg-gray-300', 'px-3 py-1 text-xs font-bold rounded-md transition']">
                                            {{ ticker }}
                                        </button>
                                    </div>
                                </div>
                                <div class="chart-container">
                                    <canvas id="priceChart"></canvas>
                                </div>
                            </div>

                            <div class="p-6 bg-white border-2 border-black rounded-xl hard-shadow">
                                <detail-view v-if="activeDetailStock" :stock="stockData[activeDetailStock]" @analyze="analyzeWithGemini"></detail-view>
                                <div v-else class="flex flex-col items-center justify-center h-full text-center">
                                    <p class="font-bold text-lg">Análisis Detallado</p>
                                    <p class="text-gray-500 text-sm">Selecciona una tarjeta para ver sus detalles y análisis con IA.</p>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </main>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, watch } = Vue;

        const kpiCard = {
            props: ['stock', 'isActive'],
            template: `
                <div @click="$emit('select', stock.ticker)" 
                    :class="[isActive ? 'bg-yellow-300' : 'bg-white', 'p-4 rounded-lg border-2 border-black cursor-pointer transition-all duration-200 hover:-translate-y-1 hover:shadow-[6px_6px_0_0_#1c1c1c]']">
                    <div class="flex items-center justify-between">
                        <h4 class="font-extrabold text-xl">{{ stock.ticker }}</h4>
                        <button @click.stop="$emit('remove', stock.ticker)" class="text-gray-400 hover:text-red-500 font-bold">&times;</button>
                    </div>
                    <p class="text-3xl font-bold my-2">$ {{ stock.lastPrice.toFixed(2) }}</p>
                    <div class="text-sm font-semibold" :class="stock.isPositive ? 'text-green-600' : 'text-red-500'">
                        {{ stock.isPositive ? '+' : '' }}{{ stock.six_month_return.toFixed(2) }}% (6m)
                    </div>
                </div>`
        };

        const detailView = {
            props: ['stock'],
            emits: ['analyze'],
            data() { return { isAnalyzing: false, analysis: null, error: null } },
            methods: {
                async performAnalysis() {
                    this.isAnalyzing = true; this.error = null; this.analysis = null;
                    const result = await this.$emit('analyze', this.stock.ticker, this.stock.name);
                    if (result) {
                        this.analysis = marked.parse(result);
                    } else {
                        this.error = "No se pudo obtener el análisis.";
                    }
                    this.isAnalyzing = false;
                }
            },
            template: `
                <div class="animate-fade-in flex flex-col h-full">
                    <div>
                        <h3 class="font-extrabold text-2xl mb-1">{{ stock.name }}</h3>
                        <p class="text-sm text-gray-500 mb-4">{{ stock.description.substring(0, 100) }}...</p>
                    </div>
                    
                    <div class="bg-gray-100 p-3 rounded-md border-2 border-black mb-4">
                        <h4 class="font-bold text-sm mb-2">Métricas Clave</h4>
                        <ul class="space-y-1 text-xs">
                            <li class="flex justify-between"><span>Ratio P/E:</span> <span class="font-bold">{{ stock.financials['P/E'] }}</span></li>
                            <li class="flex justify-between"><span>Capitalización:</span> <span class="font-bold">{{ stock.financials['Market Cap'] }}</span></li>
                        </ul>
                    </div>

                    <div class="flex-grow space-y-2">
                        <button @click="performAnalysis" :disabled="isAnalyzing" class="w-full bg-black text-white font-bold px-4 py-2 rounded-md border-2 border-black transition hover:bg-gray-800 disabled:bg-gray-400 text-sm">
                            <span v-if="!isAnalyzing">Analizar con Gemini</span>
                            <span v-if="isAnalyzing">Analizando...</span>
                        </button>
                        <div v-if="analysis" class="prose prose-sm p-3 bg-gray-100 border-2 border-black rounded-md overflow-y-auto max-h-48" v-html="analysis"></div>
                    </div>
                </div>`
        };

        createApp({
            components: { kpiCard, detailView },
            setup() {
                // --- La lógica de Vue (estado, métodos, etc.) permanece idéntica a la versión anterior ---
                const stockData = reactive({});
                const trackedStocks = ref([]);
                const selectedStocksInChart = ref([]);
                const activeDetailStock = ref(null);
                const newStockTicker = ref('');
                const isLoading = ref(false);
                const isLoadingInitial = ref(true);
                const error = ref(null);
                let chartInstance = null;
                
                const API_ENDPOINT = 'https://cerulean-cupcake-1f5893.netlify.app/.netlify/functions/fetch-stock';

                const loadStocksFromStorage = () => {
                    const stored = localStorage.getItem('trackedStocks');
                    return stored ? JSON.parse(stored) : ['TSLA', 'AMZN', 'MELI', 'GOOGL'];
                };
                const saveStocksToStorage = () => localStorage.setItem('trackedStocks', JSON.stringify(trackedStocks.value));

                const analyzeWithGemini = async (ticker, stockName) => {
                    try {
                        const response = await fetch(`${API_ENDPOINT}?ticker=${ticker}&action=analyze&stockName=${encodeURIComponent(stockName)}`);
                        if (!response.ok) throw new Error('Network response was not ok.');
                        const data = await response.json();
                        return data.analysis;
                    } catch (err) {
                        console.error("Error calling analysis function:", err);
                        return null;
                    }
                };
                
                const fetchStockData = async (ticker) => { /* ...código idéntico... */ };
                const adaptApiData = (priceData, overviewData, ticker) => { /* ...código idéntico... */ };
                const addStock = async () => { /* ...código idéntico... */ };
                const removeStock = (tickerToRemove) => { /* ...código idéntico... */ };
                
                const initializeChart = () => {
                    const ctx = document.getElementById('priceChart').getContext('2d');
                    Chart.defaults.font.family = "'Figtree', sans-serif";
                    chartInstance = new Chart(ctx, {
                        type: 'line',
                        options: { 
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { 
                                x: { grid: { display: false }, border: { color: 'black', width: 2 } }, 
                                y: { grid: { display: false }, border: { color: 'black', width: 2 } } 
                            }
                        }
                    });
                };
                
                const updateChart = () => {
                    if (!chartInstance) return;
                    const labels_hist = Array.from({length: 12}, (_, i) => `M${i-11}`);
                    const labels_proj = Array.from({length: 6}, (_, i) => `P${i+1}`);
                    chartInstance.data.labels = [...labels_hist, ...labels_proj];
                    chartInstance.data.datasets = [];
                    selectedStocksInChart.value.forEach(ticker => {
                        const stock = stockData[ticker];
                        if (!stock) return;
                        chartInstance.data.datasets.push({
                            label: `${ticker} Hist.`, data: stock.prices, borderColor: stock.color, tension: 0.3, borderWidth: 3, pointRadius: 0
                        });
                        const projectionData = Array(11).fill(null).concat([stock.lastPrice], stock.projection);
                        chartInstance.data.datasets.push({
                            label: `${ticker} Proy.`, data: projectionData, borderColor: stock.color, borderDash: [3, 3], tension: 0.3, borderWidth: 2.5, pointRadius: 0
                        });
                    });
                    chartInstance.update();
                };

                onMounted(async () => { /* ...código idéntico... */ });
                watch([selectedStocksInChart, trackedStocks], updateChart, { deep: true });

                return {
                    stockData, trackedStocks, selectedStocksInChart, activeDetailStock, newStockTicker, isLoading, isLoadingInitial, error,
                    addStock, removeStock, analyzeWithGemini,
                    setActiveDetail: (ticker) => activeDetailStock.value = ticker,
                    toggleStockInChart: (ticker) => {
                        const index = selectedStocksInChart.value.indexOf(ticker);
                        if (index > -1) selectedStocksInChart.value.splice(index, 1);
                        else selectedStocksInChart.value.push(ticker);
                    }
                };
                 
                // --- Bloques de código idénticos (acortados por brevedad) ---
                function fetchStockData(ticker) {
                    return new Promise(async (resolve) => {
                        error.value = null;
                        if (!API_ENDPOINT || API_ENDPOINT.includes('tu-sitio')) { error.value = "Configura la URL de la API."; return resolve(null); }
                        try {
                            const response = await fetch(`${API_ENDPOINT}?ticker=${ticker}`);
                            if (!response.ok) throw new Error('La respuesta de la red no fue exitosa.');
                            const { priceData, overviewData } = await response.json();
                            if (priceData['Note'] || overviewData['Note']) throw new Error('Límite de la API alcanzado.');
                            if (priceData['Error Message'] || !overviewData.Symbol) throw new Error(`Datos inválidos para ${ticker}.`);
                            resolve(adaptApiData(priceData, overviewData, ticker));
                        } catch (err) {
                            console.error(`Error al obtener datos para ${ticker}:`, err);
                            error.value = err.message || `No se pudieron obtener los datos para ${ticker}.`;
                            resolve(null);
                        }
                    });
                }
                function adaptApiData(priceData, overviewData, ticker) {
                    const timeSeries = priceData['Monthly Adjusted Time Series'];
                    const dates = Object.keys(timeSeries).sort((a,b)=>new Date(a)-new Date(b)).slice(-12);
                    const prices = dates.map(d=>parseFloat(timeSeries[d]['4. close']));
                    const lastPrice = prices[prices.length-1];
                    const sixMonthAgoPrice = prices.length>6?prices[prices.length-7]:prices[0];
                    const six_month_return = ((lastPrice-sixMonthAgoPrice)/sixMonthAgoPrice)*100;
                    let trend=(lastPrice - prices[prices.length-4])/3; let projection=[]; let projectedPrice=lastPrice;
                    for(let i=0;i<6;i++){projectedPrice+=trend+((Math.random()-0.45)*(lastPrice*0.05));projection.push(projectedPrice);}
                    return{ticker,name:overviewData.Name,description:overviewData.Description,financials:{'P/E':parseFloat(overviewData.PERatio),'Market Cap':(parseFloat(overviewData.MarketCapitalization)/1e9).toFixed(2)+'B USD','EPS':parseFloat(overviewData.EPS)},prices,lastPrice,six_month_return,isPositive:six_month_return>=0,projection,projected_price:projection[5]||lastPrice,projected_return:((projection[5]||lastPrice)-lastPrice)/lastPrice*100,color:`rgba(${Math.floor(Math.random()*200)},${Math.floor(Math.random()*200)},${Math.floor(Math.random()*200)},1)`};
                }
                async function addStock() {
                    const tickerToAdd=newStockTicker.value.toUpperCase().trim();
                    if(!tickerToAdd||trackedStocks.value.includes(tickerToAdd))return;
                    isLoading.value=true;
                    const newData=await fetchStockData(tickerToAdd);
                    isLoading.value=false;
                    if(newData){stockData[tickerToAdd]=newData;trackedStocks.value.push(tickerToAdd);selectedStocksInChart.value.push(tickerToAdd);newStockTicker.value='';saveStocksToStorage();}
                }
                function removeStock(tickerToRemove) {
                    trackedStocks.value=trackedStocks.value.filter(t=>t!==tickerToRemove);
                    selectedStocksInChart.value=selectedStocksInChart.value.filter(t=>t!==tickerToRemove);
                    if(activeDetailStock.value===tickerToRemove)activeDetailStock.value=null;
                    delete stockData[tickerToRemove];saveStocksToStorage();
                }
                async function onMounted() {
                    const initialStocks = loadStocksFromStorage();
                    const results = await Promise.all(initialStocks.map(ticker => fetchStockData(ticker)));
                    results.forEach((data,index)=>{if(data){const ticker=initialStocks[index];stockData[ticker]=data;trackedStocks.value.push(ticker);selectedStocksInChart.value.push(ticker);}});
                    isLoadingInitial.value=false;
                    setTimeout(()=>{if(trackedStocks.value.length>0){initializeChart();updateChart();}},0);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
