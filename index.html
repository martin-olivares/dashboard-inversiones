<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Inversiones Profesional</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Paleta de Colores y Estilos Base */
        :root {
            --background: #fdfdfd;
            --surface: #ffffff;
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --subtle-glow: 0px 0px 15px 0px rgba(79, 70, 229, 0.1);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--background); 
            color: var(--text-primary);
        }

        /* Oculta elementos hasta que Vue esté listo */
        [v-cloak] { display: none; }

        /* Estilos para el Gráfico */
        .chart-container { 
            position: relative; 
            height: 45vh; 
            max-height: 450px; 
            min-height: 400px;
        }

        /* Animación de entrada para los elementos */
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Icono de Carga Mejorado */
        .loader {
            width: 48px;
            height: 48px;
            border: 3px solid var(--primary);
            border-radius: 50%;
            display: inline-block;
            position: relative;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        .loader::after {
            content: '';  
            box-sizing: border-box;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid;
            border-color: var(--background) transparent;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">

    <div id="app" v-cloak class="min-h-screen flex flex-col">
        
        <nav class="bg-white/70 backdrop-blur-lg border-b border-slate-200 sticky top-0 z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <svg class="h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                            </svg>
                        </div>
                        <div class="ml-4">
                            <h1 class="text-xl font-bold text-slate-800">Análisis Bursátil</h1>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container mx-auto p-4 md:p-8 max-w-7xl flex-grow">
            <header class="text-left mb-10">
                <h2 class="text-3xl md:text-4xl font-extrabold text-slate-900 tracking-tight">Dashboard de Activos</h2>
                <p class="text-slate-500 mt-2 text-lg">Monitorea activos en tiempo real y revisa proyecciones simuladas.</p>
            </header>

            <main class="space-y-8">
                <section class="bg-white p-6 rounded-xl shadow-md border border-slate-200/80">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Añadir Activo Financiero</h3>
                    <div class="flex flex-col md:flex-row items-center gap-3">
                        <input type="text" v-model="newStockTicker" @keyup.enter="addStock" placeholder="Ticker, ej: AAPL, MSFT, MELI" class="w-full flex-grow px-4 py-2 bg-slate-50 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        <button @click="addStock" :disabled="isLoading" class="w-full md:w-auto bg-indigo-600 text-white font-semibold px-5 py-2 rounded-md hover:bg-indigo-700 transition-all duration-200 disabled:bg-slate-400 disabled:cursor-not-allowed flex items-center justify-center space-x-2 shadow-sm hover:shadow-md">
                            <span v-if="!isLoading">Agregar</span>
                            <span v-if="isLoading">Cargando...</span>
                        </button>
                    </div>
                    <p v-if="error" class="text-red-500 text-sm mt-3 animate-fade-in">{{ error }}</p>
                </section>

                <section>
                    <div v-if="isLoadingInitial" class="flex justify-center p-10"><div class="loader"></div></div>
                    <div v-else class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                        <kpi-card v-for="ticker in trackedStocks" :key="ticker" :stock="stockData[ticker]" :is-active="activeDetailStock === ticker" @select="setActiveDetail" @remove="removeStock"></kpi-card>
                    </div>
                </section>
                
                <template v-if="trackedStocks.length > 0">
                    <section class="bg-white p-6 rounded-xl shadow-md border border-slate-200/80">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold text-slate-800 mb-3 md:mb-0">Histórico y Proyección de Precios</h3>
                            <div class="flex flex-wrap justify-center gap-2">
                                <button v-for="ticker in trackedStocks" :key="ticker" @click="toggleStockInChart(ticker)" :class="[selectedStocksInChart.includes(ticker) ? 'bg-indigo-600 text-white shadow-sm' : 'bg-slate-100 text-slate-600 hover:bg-slate-200', 'px-3 py-1.5 text-xs font-bold rounded-full transition-all duration-200']">
                                    {{ ticker }}
                                </button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="priceChart"></canvas>
                        </div>
                    </section>

                    <section>
                        <div class="min-h-[200px] bg-white p-8 rounded-xl shadow-md border border-slate-200/80">
                            <detail-view v-if="activeDetailStock" :stock="stockData[activeDetailStock]"></detail-view>
                            <div v-else class="flex items-center justify-center h-full">
                                 <p class="text-slate-500 text-lg text-center">Selecciona una tarjeta para ver su análisis detallado aquí.</p>
                            </div>
                        </div>
                    </section>
                </template>
            </main>
        </div>
        
        <footer class="text-center mt-12 py-6 border-t border-slate-200 bg-white">
            <p class="text-sm text-slate-500">&copy; 2025 Análisis de Mercado. Datos con fines demostrativos.</p>
        </footer>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, watch } = Vue;

        const kpiCard = {
            props: ['stock', 'isActive'],
            template: `
                <div @click="$emit('select', stock.ticker)" 
                    :class="[isActive ? 'border-indigo-500 ring-2 ring-indigo-200' : 'border-slate-200/80', 'bg-white p-4 rounded-lg cursor-pointer border transition-all duration-200 hover:-translate-y-1 hover:shadow-lg hover:border-indigo-400']">
                    <div class="flex items-start justify-between mb-2">
                        <div>
                            <h4 class="font-bold text-lg text-slate-800">{{ stock.ticker }}</h4>
                            <span class="text-xs text-slate-500">{{ stock.name.split(' ')[0] }}</span>
                        </div>
                        <button @click.stop="$emit('remove', stock.ticker)" class="text-slate-400 hover:text-red-500 text-xl font-bold">&times;</button>
                    </div>
                    <p class="text-3xl font-semibold text-slate-900 my-1">$ {{ stock.lastPrice.toFixed(2) }}</p>
                    <div class="flex items-center text-sm font-semibold" :class="stock.isPositive ? 'text-emerald-500' : 'text-red-500'">
                        <span>{{ stock.six_month_return.toFixed(2) }}% (6m)</span>
                    </div>
                </div>`
        };

        const detailView = {
            props: ['stock'],
            template: `
                <div class="animate-fade-in">
                    <div class="mb-4">
                        <h3 class="text-2xl font-bold text-slate-900">{{ stock.name }} ({{ stock.ticker }})</h3>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                            <p class="text-slate-600 mb-6 text-justify leading-relaxed">{{ stock.description }}</p>
                            <div class="bg-indigo-50 border-l-4 border-indigo-500 p-4 rounded-r-lg">
                                <h4 class="font-semibold text-indigo-900 mb-1">Resumen de Proyección</h4>
                                <p class="text-indigo-800 text-sm">
                                    Se proyecta que {{ stock.ticker }} alcance un precio aprox. de 
                                    <strong class="font-bold">$ {{ stock.projected_price.toFixed(2) }}</strong> en 6 meses,
                                    con un rendimiento potencial del <strong :class="stock.projected_return >= 0 ? 'text-emerald-600' : 'text-red-600'">{{ stock.projected_return.toFixed(2) }}%</strong>.
                                </p>
                            </div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                            <h4 class="font-semibold text-lg mb-3 text-slate-800">Métricas Clave</h4>
                            <ul class="space-y-3 text-slate-700 text-sm">
                                <li class="flex justify-between"><span>Ratio P/E:</span> <span class="font-medium text-slate-900">{{ stock.financials['P/E'] }}</span></li>
                                <li class="flex justify-between"><span>Capitalización:</span> <span class="font-medium text-slate-900">{{ stock.financials['Market Cap'] }}</span></li>
                                <li class="flex justify-between"><span>EPS:</span> <span class="font-medium text-slate-900">{{ stock.financials.EPS }}</span></li>
                            </ul>
                        </div>
                    </div>
                </div>`
        };

        createApp({
            components: { kpiCard, detailView },
            setup() {
                const stockData = reactive({});
                const trackedStocks = ref([]);
                const selectedStocksInChart = ref([]);
                const activeDetailStock = ref(null);
                const newStockTicker = ref('');
                const isLoading = ref(false);
                const isLoadingInitial = ref(true);
                const error = ref(null);
                let chartInstance = null;
                
                // TU API ENDPOINT VA AQUÍ
                const API_ENDPOINT = 'https://cerulean-cupcake-1f5893.netlify.app/.netlify/functions/fetch-stock'; 

                const loadStocksFromStorage = () => {
                    const stored = localStorage.getItem('trackedStocks');
                    return stored ? JSON.parse(stored) : ['TSLA', 'AMZN', 'MELI', 'GOOGL'];
                };

                const saveStocksToStorage = () => {
                    localStorage.setItem('trackedStocks', JSON.stringify(trackedStocks.value));
                };

                const fetchStockData = async (ticker) => {
                    error.value = null;
                    if (!API_ENDPOINT || API_ENDPOINT.includes('tu-sitio')) {
                        error.value = "Por favor, configura la URL de la API en el código.";
                        return null;
                    }
                    try {
                        const response = await fetch(`${API_ENDPOINT}?ticker=${ticker}`);
                        if (!response.ok) throw new Error('La respuesta de la red no fue exitosa.');
                        const { priceData, overviewData } = await response.json();

                        if (priceData['Note'] || overviewData['Note']) {
                            throw new Error('Límite de la API alcanzado. Intenta más tarde.');
                        }
                        if (priceData['Error Message'] || !overviewData.Symbol) {
                            throw new Error(`Datos inválidos para ${ticker}.`);
                        }
                        return adaptApiData(priceData, overviewData, ticker);
                    } catch (err) {
                        console.error(`Error al obtener datos para ${ticker}:`, err);
                        error.value = err.message || `No se pudieron obtener los datos para ${ticker}.`;
                        return null;
                    }
                };

                const adaptApiData = (priceData, overviewData, ticker) => {
                    const timeSeries = priceData['Monthly Adjusted Time Series'];
                    const dates = Object.keys(timeSeries).sort((a, b) => new Date(a) - new Date(b)).slice(-12);
                    const prices = dates.map(date => parseFloat(timeSeries[date]['4. close']));
                    const lastPrice = prices[prices.length - 1];
                    const sixMonthAgoPrice = prices.length > 6 ? prices[prices.length - 7] : prices[0];
                    const six_month_return = ((lastPrice - sixMonthAgoPrice) / sixMonthAgoPrice) * 100;

                    let trend = (lastPrice - prices[prices.length - 4]) / 3;
                    let projection = [];
                    let projectedPrice = lastPrice;
                    for (let i = 0; i < 6; i++) {
                        projectedPrice += trend + ((Math.random() - 0.45) * (lastPrice * 0.05));
                        projection.push(projectedPrice);
                    }
                    
                    return {
                        ticker,
                        name: overviewData.Name,
                        description: overviewData.Description,
                        financials: {
                            'P/E': parseFloat(overviewData.PERatio),
                            'Market Cap': (parseFloat(overviewData.MarketCapitalization) / 1e9).toFixed(2) + 'B USD',
                            'EPS': parseFloat(overviewData.EPS),
                        },
                        prices, lastPrice, six_month_return,
                        isPositive: six_month_return >= 0,
                        projection,
                        projected_price: projection[5] || lastPrice,
                        projected_return: ((projection[5] || lastPrice) - lastPrice) / lastPrice * 100,
                        color: `rgba(${Math.floor(Math.random()*200)}, ${Math.floor(Math.random()*200)}, ${Math.floor(Math.random()*200)}, 1)`
                    };
                };
                
                const addStock = async () => {
                    const tickerToAdd = newStockTicker.value.toUpperCase().trim();
                    if (!tickerToAdd || trackedStocks.value.includes(tickerToAdd)) return;
                    
                    isLoading.value = true;
                    const newData = await fetchStockData(tickerToAdd);
                    isLoading.value = false;

                    if (newData) {
                        stockData[tickerToAdd] = newData;
                        trackedStocks.value.push(tickerToAdd);
                        selectedStocksInChart.value.push(tickerToAdd);
                        newStockTicker.value = '';
                        saveStocksToStorage();
                    }
                };

                const removeStock = (tickerToRemove) => {
                    trackedStocks.value = trackedStocks.value.filter(t => t !== tickerToRemove);
                    selectedStocksInChart.value = selectedStocksInChart.value.filter(t => t !== tickerToRemove);
                    if (activeDetailStock.value === tickerToRemove) activeDetailStock.value = null;
                    delete stockData[tickerToRemove];
                    saveStocksToStorage();
                };

                const initializeChart = () => {
                    const ctx = document.getElementById('priceChart').getContext('2d');
                    chartInstance = new Chart(ctx, {
                        type: 'line',
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { x: { grid: { display: false } }, y: { grid: { color: '#e5e7eb' } } }
                        }
                    });
                };
                
                const updateChart = () => {
                    if (!chartInstance) return;
                    
                    const labels_hist = Array.from({length: 12}, (_, i) => `M ${i - 11}`);
                    const labels_proj = Array.from({length: 6}, (_, i) => `P ${i + 1}`);
                    chartInstance.data.labels = [...labels_hist, ...labels_proj];
                    chartInstance.data.datasets = [];

                    selectedStocksInChart.value.forEach(ticker => {
                        const stock = stockData[ticker];
                        if (!stock) return;
                        
                        chartInstance.data.datasets.push({
                            label: `${ticker} Hist.`, data: stock.prices, borderColor: stock.color, tension: 0.3, borderWidth: 2.5, pointRadius: 0
                        });
                        const projectionData = Array(11).fill(null).concat([stock.lastPrice], stock.projection);
                        chartInstance.data.datasets.push({
                            label: `${ticker} Proy.`, data: projectionData, borderColor: stock.color, borderDash: [4, 4], tension: 0.3, borderWidth: 2, pointRadius: 0
                        });
                    });
                    chartInstance.update();
                };

                onMounted(async () => {
                    const initialStocks = loadStocksFromStorage();
                    const results = await Promise.all(initialStocks.map(ticker => fetchStockData(ticker)));

                    results.forEach((data, index) => {
                        if (data) {
                            const ticker = initialStocks[index];
                            stockData[ticker] = data;
                            trackedStocks.value.push(ticker);
                            selectedStocksInChart.value.push(ticker);
                        }
                    });
                    
                    isLoadingInitial.value = false;
                    
                    setTimeout(() => {
                        if (trackedStocks.value.length > 0) {
                            initializeChart();
                            updateChart();
                        }
                    }, 0);
                });

                watch([selectedStocksInChart, trackedStocks], updateChart, { deep: true });

                return {
                    stockData, trackedStocks, selectedStocksInChart, activeDetailStock, newStockTicker, isLoading, isLoadingInitial, error,
                    addStock, removeStock,
                    setActiveDetail: (ticker) => activeDetailStock.value = ticker,
                    toggleStockInChart: (ticker) => {
                        const index = selectedStocksInChart.value.indexOf(ticker);
                        if (index > -1) selectedStocksInChart.value.splice(index, 1);
                        else selectedStocksInChart.value.push(ticker);
                    }
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
