<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Inversiones Profesional</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .chart-container { position: relative; height: 45vh; max-height: 500px; }
        [v-cloak] { display: none; } /* Oculta elementos hasta que Vue esté listo */
    </style>
</head>
<body class="text-slate-800">

    <div id="app" v-cloak class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-slate-900">Dashboard de Inversiones</h1>
            <p class="text-slate-500 mt-2 text-lg">Análisis de activos con datos en tiempo real y proyecciones simuladas.</p>
        </header>

        <main class="space-y-8">
            <section class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
                <h2 class="text-xl font-bold text-slate-900 mb-4">Añadir Activo Financiero</h2>
                <div class="flex flex-col md:flex-row items-center gap-4">
                    <input type="text" v-model="newStockTicker" @keyup.enter="addStock" placeholder="Ej: AAPL, MSFT, MELI" class="w-full flex-grow px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition">
                    <button @click="addStock" :disabled="isLoading" class="w-full md:w-auto bg-blue-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-blue-700 transition-all duration-200 disabled:bg-slate-400 disabled:cursor-not-allowed flex items-center justify-center space-x-2">
                        <span v-if="!isLoading">Agregar</span>
                        <span v-else>Cargando...</span>
                    </button>
                </div>
                <p v-if="error" class="text-red-500 text-sm mt-2">{{ error }}</p>
            </section>

            <section>
                <div v-if="isLoadingInitial" class="flex justify-center p-10"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div></div>
                <div v-else class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                    <kpi-card v-for="ticker in trackedStocks" :key="ticker" :stock="stockData[ticker]" :is-active="activeDetailStock === ticker" @select="setActiveDetail" @remove="removeStock"></kpi-card>
                </div>
            </section>
            
            <template v-if="trackedStocks.length > 0">
                <section class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-slate-900 mb-3 md:mb-0">Histórico y Proyección de Precios</h2>
                        <div class="flex flex-wrap justify-center gap-2">
                            <button v-for="ticker in trackedStocks" :key="ticker" @click="toggleStockInChart(ticker)" :class="[selectedStocksInChart.includes(ticker) ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-700', 'px-3 py-1.5 text-sm font-medium rounded-full transition-all duration-200']">
                                {{ ticker }}
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="priceChart"></canvas>
                    </div>
                </section>

                <section>
                    <div class="min-h-[200px] bg-white p-8 rounded-2xl shadow-lg border border-slate-200 transition-opacity duration-500 ease-in-out">
                        <detail-view v-if="activeDetailStock" :stock="stockData[activeDetailStock]"></detail-view>
                        <div v-else class="flex items-center justify-center h-full">
                             <p class="text-slate-500 text-lg">Seleccione una acción para ver su análisis detallado.</p>
                        </div>
                    </div>
                </section>
            </template>
        </main>
        
        <footer class="text-center mt-12 py-6 border-t border-slate-200">
            <p class="text-sm text-slate-500">&copy; 2025 Análisis de Mercado. Datos con fines demostrativos.</p>
        </footer>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, watch } = Vue;

        // --- COMPONENTES DE VUE ---
        
        // Tarjeta KPI
        const kpiCard = {
            props: ['stock', 'isActive'],
            template: `
                <div @click="$emit('select', stock.ticker)" 
                    :class="[isActive ? 'border-blue-500 ring-2 ring-blue-200' : 'border-slate-200', 'bg-white p-4 rounded-xl shadow-md cursor-pointer border-2 transition-all duration-200 hover:-translate-y-1 hover:shadow-xl']">
                    <div class="flex items-start justify-between mb-2">
                        <div>
                            <h3 class="font-bold text-lg">{{ stock.ticker }}</h3>
                            <span class="text-xs text-slate-500">{{ stock.name.split(' ')[0] }}</span>
                        </div>
                        <button @click.stop="$emit('remove', stock.ticker)" class="text-slate-400 hover:text-red-500 text-xl font-bold">&times;</button>
                    </div>
                    <p class="text-3xl font-semibold mb-1">$ {{ stock.lastPrice.toFixed(2) }}</p>
                    <div class="flex items-center text-sm" :class="stock.isPositive ? 'text-green-600' : 'text-red-600'">
                        <span>{{ stock.six_month_return.toFixed(2) }}% (6m)</span>
                    </div>
                </div>`
        };

        // Vista Detallada
        const detailView = {
            props: ['stock'],
            template: `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 animate-fade-in">
                    <div class="md:col-span-2">
                        <h3 class="text-3xl font-bold text-slate-900 mb-2">{{ stock.name }} ({{ stock.ticker }})</h3>
                        <p class="text-slate-600 mb-4 text-justify">{{ stock.description }}</p>
                        <h4 class="font-semibold text-lg mb-2">Resumen de Proyección</h4>
                        <p class="text-slate-600">
                            Se proyecta que {{ stock.ticker }} alcance un precio aproximado de 
                            <strong class="text-slate-800">$ {{ stock.projected_price.toFixed(2) }}</strong> en 6 meses,
                            con un rendimiento potencial del <strong :class="stock.projected_return >= 0 ? 'text-green-600' : 'text-red-600'}">{{ stock.projected_return.toFixed(2) }}%</strong>.
                        </p>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <h4 class="font-semibold text-lg mb-3">Métricas Clave</h4>
                        <ul class="space-y-2 text-slate-700 text-sm">
                            <li class="flex justify-between"><span>Ratio P/E:</span> <span class="font-medium">{{ stock.financials['P/E'] }}</span></li>
                            <li class="flex justify-between"><span>Capitalización:</span> <span class="font-medium">{{ stock.financials['Market Cap'] }}</span></li>
                            <li class="flex justify-between"><span>EPS:</span> <span class="font-medium">{{ stock.financials.EPS }}</span></li>
                        </ul>
                    </div>
                </div>`
        };


        // --- APLICACIÓN PRINCIPAL DE VUE ---
        createApp({
            components: { kpiCard, detailView },
            setup() {
                // --- Estado Reactivo ---
                const stockData = reactive({});
                const trackedStocks = ref([]);
                const selectedStocksInChart = ref([]);
                const activeDetailStock = ref(null);
                const newStockTicker = ref('');
                const isLoading = ref(false);
                const isLoadingInitial = ref(true);
                const error = ref(null);
                let chartInstance = null;
                
                // --- CONFIGURACIÓN ---
                // Pega aquí la URL de tu función de Netlify
                const API_ENDPOINT = 'https://tu-sitio.netlify.app/.netlify/functions/tu-funcion'; 

                // --- Métodos ---
                const loadStocksFromStorage = () => {
                    const stored = localStorage.getItem('trackedStocks');
                    return stored ? JSON.parse(stored) : ['TSLA', 'AMZN', 'MELI', 'GOOGL'];
                };

                const saveStocksToStorage = () => {
                    localStorage.setItem('trackedStocks', JSON.stringify(trackedStocks.value));
                };

                const fetchStockData = async (ticker) => {
                    if (API_ENDPOINT === 'https://tu-sitio.netlify.app/.netlify/functions/tu-funcion') {
                        error.value = "Por favor, configura la URL de la API en el código.";
                        return null;
                    }
                    try {
                        const response = await fetch(`${API_ENDPOINT}?ticker=${ticker}`);
                        if (!response.ok) throw new Error('Network response was not ok.');
                        const { priceData, overviewData } = await response.json();

                        if (priceData['Error Message'] || !overviewData.Symbol) {
                            throw new Error(`Datos inválidos para ${ticker}.`);
                        }
                        
                        return adaptApiData(priceData, overviewData, ticker);

                    } catch (err) {
                        console.error(`Error fetching data for ${ticker}:`, err);
                        error.value = `No se pudieron obtener los datos para ${ticker}. Puede ser un ticker inválido.`;
                        return null;
                    }
                };

                const adaptApiData = (priceData, overviewData, ticker) => {
                    const timeSeries = priceData['Monthly Adjusted Time Series'];
                    const dates = Object.keys(timeSeries).sort((a, b) => new Date(a) - new Date(b)).slice(-12);
                    const prices = dates.map(date => parseFloat(timeSeries[date]['4. close']));
                    const lastPrice = prices[prices.length - 1];
                    const sixMonthAgoPrice = prices.length > 6 ? prices[prices.length - 7] : prices[0];
                    const six_month_return = ((lastPrice - sixMonthAgoPrice) / sixMonthAgoPrice) * 100;

                    // Proyecciones
                    let trend = (lastPrice - prices[prices.length - 4]) / 3;
                    let projection = [];
                    let projectedPrice = lastPrice;
                    for (let i = 0; i < 6; i++) {
                        projectedPrice += trend + ((Math.random() - 0.45) * (lastPrice * 0.05));
                        projection.push(projectedPrice);
                    }
                    
                    return {
                        ticker,
                        name: overviewData.Name,
                        description: overviewData.Description,
                        financials: {
                            'P/E': parseFloat(overviewData.PERatio),
                            'Market Cap': (parseFloat(overviewData.MarketCapitalization) / 1e9).toFixed(2) + 'B USD',
                            'EPS': parseFloat(overviewData.EPS),
                        },
                        prices,
                        lastPrice,
                        six_month_return,
                        isPositive: six_month_return >= 0,
                        projection,
                        projected_price: projection[5] || lastPrice,
                        projected_return: ((projection[5] || lastPrice) - lastPrice) / lastPrice * 100,
                        color: `rgba(${Math.floor(Math.random()*200)}, ${Math.floor(Math.random()*200)}, ${Math.floor(Math.random()*200)}, 1)`
                    };
                };
                
                const addStock = async () => {
                    const tickerToAdd = newStockTicker.value.toUpperCase().trim();
                    if (!tickerToAdd || trackedStocks.value.includes(tickerToAdd)) return;
                    
                    isLoading.value = true;
                    error.value = null;
                    const newData = await fetchStockData(tickerToAdd);
                    isLoading.value = false;

                    if (newData) {
                        stockData[tickerToAdd] = newData;
                        trackedStocks.value.push(tickerToAdd);
                        selectedStocksInChart.value.push(tickerToAdd);
                        newStockTicker.value = '';
                        saveStocksToStorage();
                    }
                };

                const removeStock = (tickerToRemove) => {
                    trackedStocks.value = trackedStocks.value.filter(t => t !== tickerToRemove);
                    selectedStocksInChart.value = selectedStocksInChart.value.filter(t => t !== tickerToRemove);
                    if (activeDetailStock.value === tickerToRemove) {
                        activeDetailStock.value = null;
                    }
                    delete stockData[tickerToRemove];
                    saveStocksToStorage();
                };

                const initializeChart = () => {
                    const ctx = document.getElementById('priceChart').getContext('2d');
                    chartInstance = new Chart(ctx, {
                        type: 'line',
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                };
                
                const updateChart = () => {
                    if (!chartInstance) return;
                    
                    const labels_hist = Array.from({length: 12}, (_, i) => `M ${i - 11}`);
                    const labels_proj = Array.from({length: 6}, (_, i) => `P ${i + 1}`);
                    chartInstance.data.labels = [...labels_hist, ...labels_proj];
                    chartInstance.data.datasets = [];

                    selectedStocksInChart.value.forEach(ticker => {
                        const stock = stockData[ticker];
                        if (!stock) return;
                        
                        chartInstance.data.datasets.push({
                            label: `${ticker} Hist.`, data: stock.prices, borderColor: stock.color, tension: 0.1, borderWidth: 2,
                        });
                        const projectionData = Array(11).fill(null).concat([stock.lastPrice], stock.projection);
                        chartInstance.data.datasets.push({
                            label: `${ticker} Proy.`, data: projectionData, borderColor: stock.color, borderDash: [5, 5], tension: 0.1, borderWidth: 2,
                        });
                    });
                    chartInstance.update();
                };

                // --- Ciclo de Vida y Watchers ---
                onMounted(async () => {
                    const initialStocks = loadStocksFromStorage();
                    
                    const results = await Promise.all(
                        initialStocks.map(ticker => fetchStockData(ticker))
                    );

                    results.forEach((data, index) => {
                        if (data) {
                            const ticker = initialStocks[index];
                            stockData[ticker] = data;
                            trackedStocks.value.push(ticker);
                            selectedStocksInChart.value.push(ticker);
                        }
                    });
                    
                    isLoadingInitial.value = false;
                    
                    // Asegurarse que el DOM está listo para el gráfico
                    setTimeout(() => {
                        if (trackedStocks.value.length > 0) {
                            initializeChart();
                            updateChart();
                        }
                    }, 0);
                });

                watch([selectedStocksInChart, trackedStocks], updateChart, { deep: true });

                return {
                    stockData, trackedStocks, selectedStocksInChart, activeDetailStock, newStockTicker, isLoading, isLoadingInitial, error,
                    addStock, removeStock,
                    setActiveDetail: (ticker) => activeDetailStock.value = ticker,
                    toggleStockInChart: (ticker) => {
                        const index = selectedStocksInChart.value.indexOf(ticker);
                        if (index > -1) selectedStocksInChart.value.splice(index, 1);
                        else selectedStocksInChart.value.push(ticker);
                    }
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
